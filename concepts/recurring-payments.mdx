---
title: "Recurring Payments"
description: "Automated subscription billing with intelligent retry logic, multi-frequency support, and seamless payment processor integration"
---

## What are Recurring Payments?

**Recurring Payments** in Journey are automated billing transactions that execute on defined schedules without manual intervention. Journey's system handles everything from payment method storage to retry logic, enabling businesses to run subscription models with minimal operational overhead.

<Info>
**Key Innovation:** Journey's recurring payment engine supports multi-frequency billing within a single subscription, automatic dunning management, and seamless switching between payment processors (Straumur, Reepay, Rapyd) without code changes.
</Info>

## How Recurring Payments Work

Journey's billing system operates on a delivery-centric model where payments are tied to delivery or charge dates:

<Steps>
<Step title="Subscription Created">
Customer signs up with payment method verification
</Step>

<Step title="Orders Generated">
System creates orders from subscription recipe based on item frequencies
</Step>

<Step title="Deliveries Scheduled">
Each order gets a delivery or charge date (depending on whether the merchant is uses physical products or not)
</Step>

<Step title="Automated Charging">
On delivery/charge date, system automatically charges the customer's payment method
</Step>

<Step title="Status Updates">
Payment status updates subscription state (active, past_due, error, expired)
</Step>

<Step title="Dunning Management">
Failed payments trigger automatic retry sequences with customer notifications
</Step>
</Steps>

### Payment Flow Diagram

```mermaid
graph TD
    A[Delivery/Charge Date Arrives] -->|Midnight Cron| B[Create Payment Object]
    B --> C{Payment Method Valid?}
    C -->|Yes| D[Charge Payment Processor]
    C -->|No| E[Mark as Failed]
    D --> F{Charge Successful?}
    F -->|Yes| G[Status: Settled]
    F -->|No - Retryable| H[Status: Past Due]
    F -->|No - Error| I[Status: Error]
    G --> J[Subscription: Active]
    H --> K[Start Dunning]
    I --> L[Requires Intervention]
    K --> M{Retry Succeeds?}
    M -->|Yes| J
    M -->|No - Day 20| N[Status: Expired]
```

## Payment States

Payments progress through clearly defined states:

```mermaid
graph LR
    A[New Charge] --> B[Authorized]
    B --> C[Settled]
    A --> D[Failed]
    D --> E{Retryable?}
    E -->|Yes| F[Retry Tomorrow]
    E -->|No| G[Cancelled]
    F -.->|Succeeds| C
    F -.->|Max Retries| G
    C --> H[Refunded]
```

### Status Definitions

<AccordionGroup>
  <Accordion title="New Charge" icon="plus">
    Payment object created but not yet attempted. Occurs when delivery/charge date arrives and system creates initial payment record.

    **Next Step:** Immediate charge attempt via payment processor
  </Accordion>

  <Accordion title="Authorized" icon="lock">
    Payment method has been authorized (pre-authorized) but funds not yet captured. Common with Reepay and some Rapyd flows.

    **Next Step:** Capture funds when delivery ships
  </Accordion>

  <Accordion title="Settled" icon="circle-check">
    Money successfully captured and transferred. This is the successful end state.

    **Effect:** Subscription remains/returns to active status
  </Accordion>

  <Accordion title="Failed" icon="circle-xmark">
    Payment attempt was declined by payment processor or bank.

    **Triggers:**
    - Insufficient funds (past_due)
    - Expired card (error)
    - Invalid card (error)
    - Technical issues (error)

    **Next Step:** Automatic retry based on error classification
  </Accordion>

  <Accordion title="Cancelled" icon="ban">
    Payment was cancelled due to:
    - Max retry attempts exceeded (20 days default)
    - Delivery cancelled before charge
    - Merchant manually cancelled

    **Final State:** No further processing
  </Accordion>

  <Accordion title="Refunded" icon="rotate-left">
    Previously settled payment has been refunded to customer.

    **Triggers:**
    - Customer return
    - Merchant error
    - Service cancellation

    **Process:** Full or partial refund via payment processor API
  </Accordion>

  <Accordion title="Uncapturable" icon="hourglass-end">
    Authorization has expired before capture (typically 7 days for card authorizations).

    **Resolution:** New authorization required
  </Accordion>
</AccordionGroup>

## Multi-Frequency Billing

Journey uniquely supports different billing frequencies for items within a single subscription.

### How It Works

**Traditional Systems:**
```
All items share one frequency
❌ Customer must create separate subscriptions for different schedules
❌ Higher operational complexity
❌ More payment transactions = more fees
```

**Journey's Approach:**
```
Each item has its own frequency
✅ Single subscription for all items
✅ Intelligent delivery synchronization
✅ Fewer transactions through batching
```

### Example: Grocery Subscription

```json
{
  "subscription_id": 789,
  "order_items": [
    {
      "product": "Fresh Milk",
      "frequency": "every_7_days",
      "next_charge": "2025-11-01"
    },
    {
      "product": "Eggs",
      "frequency": "every_14_days",
      "next_charge": "2025-11-08"
    },
    {
      "product": "Coffee Beans",
      "frequency": "every_30_days",
      "next_charge": "2025-11-15"
    }
  ]
}
```

**Billing Schedule:**
- **Nov 1:** Charge for Milk only
- **Nov 8:** Charge for Milk + Eggs (synchronized)
- **Nov 15:** Charge for Milk + Coffee (synchronized)
- **Nov 22:** Charge for Milk + Eggs (synchronized)

<Info>
Journey's 5-day synchronization window automatically batches items, reducing payment processing fees by up to 60% compared to separate charges.
</Info>

## Payment Processors

Journey supports multiple payment processors with unified API:

| Processor | Region | Features | Use Case |
|-----------|--------|----------|----------|
| **Straumur** | Iceland | Local cards, low fees | Icelandic merchants |
| **Reepay** | Europe | SEPA, cards, subscriptions | European expansion |
| **Rapyd** | Global | 900+ payment methods | International markets |

### Processor Configuration

<Tabs>
  <Tab title="Straumur">
    ```json
    {
      "name": "Straumur",
      "merchant_id": "your_merchant_id",
      "terminal_identifier_gateway": "your_terminal_id",
      "terminal_identifier_pos": "your_pos_terminal_id",
      "shared_secret": "your_secret",
      "payment_page_url": "https://test.straumur.is/payment/"
    }
    ```

    **Capabilities:**
    - Icelandic debit/credit cards
    - Token-based recurring payments
    - Pre-authorization and capture
    - Refunds and voids
  </Tab>

  <Tab title="Reepay">
    ```json
    {
      "name": "Reepay",
      "private_key": "priv_...",
      "webhook_secret": "whsec_..."
    }
    ```

    **Capabilities:**
    - European cards (SEPA region)
    - Native subscription management
    - Dunning built-in
    - Webhook notifications
  </Tab>

  <Tab title="Rapyd">
    ```json
    {
      "name": "Rapyd",
      "access_key": "your_access_key",
      "secret_key": "your_secret_key"
    }
    ```

    **Capabilities:**
    - 900+ payment methods globally
    - Virtual card numbers
    - Multi-currency support
    - Compliance tools
  </Tab>
</Tabs>

### Processor Selection

Journey **doesn't automatically select the payment processor**. Instead, it provides flexibility for merchants to configure which processor to use based on their business needs.

**Configuration Options:**
1. **Per-Subscription Level** - Assign specific processor when creating subscription
2. **Per-Customer Level** - Set preferred processor for customer's payment methods
3. **Multiple Processors** - Journey supports running multiple payment processors simultaneously, allowing you to:
   - Test new processors without migrating existing customers
   - Offer region-specific payment options
   - Segment customers by processor (e.g., B2B vs B2C)
   - Gradually migrate between processors

**Selection Priority:**
The system checks for a processor in this order:
1. Processor explicitly assigned to the subscription
2. Customer's preferred processor (from their payment method)
3. Merchant's default payment processor

<Info>
You can have multiple payment processors active at the same time. For example, use Straumur for Icelandic customers and Reepay for international customers within the same merchant account.
</Info>

<Warning>
Once a subscription starts with a processor, changing processors mid-cycle requires customer re-verification and may interrupt service.
</Warning>

## Automated Billing Cron

Journey runs daily billing automation to handle recurring payment processing automatically.

### Cron Job Workflow

The system performs several key operations each day:

<Steps>
<Step title="Process New Deliveries">
The system identifies deliveries scheduled for today that haven't been charged yet. For each eligible delivery:
- Creates a payment record
- Charges the customer's payment method
- Updates subscription status based on payment result

**Result:** New charges processed for today's deliveries
</Step>

<Step title="Capture Authorized Payments">
For payment processors that use two-step authorization (authorize → capture), the system finds payments that were pre-authorized and are now ready to be captured when their delivery date arrives.

**Result:** Pre-authorized payments captured and funds transferred
</Step>

<Step title="Retry Failed Payments">
The system identifies subscriptions with failed payments that are eligible for retry (within the configured retry window and daily retry limit). Each payment is attempted once per day.

**Result:** Daily retry attempts for recoverable payment failures
</Step>

<Step title="Cancel Old Failed Payments">
Payments that have exceeded the maximum retry period (typically 20 days) are automatically cancelled. The associated subscriptions are expired and future deliveries are cancelled.

**Result:** Expired subscriptions and cancelled deliveries for unrecoverable payments
</Step>

<Step title="Send Dunning Communications">
Customer notifications are triggered based on payment attempt counts:
- First failure: Friendly reminder
- Every 4th attempt: Urgent reminder with days remaining
- Final attempt: Last chance notice
- After expiration: Subscription cancelled notice

**Result:** Automated customer communication throughout the dunning process
</Step>
</Steps>

### Monitoring

Journey provides comprehensive monitoring of the automated billing process:

**Logging:**
- All cron job executions are logged with timestamps and results
- Errors are captured with full context for debugging
- Processing summaries show counts of payments processed, retries attempted, and subscriptions updated

**Alerts:**
- Payment processor failures trigger immediate alerts
- Unusually high retry rates indicate potential issues
- Authorization decline spikes warrant investigation
- Processing time exceeding thresholds

## Payment Retry Logic

Journey implements intelligent retry logic based on error classification.

### Error Classification

| Error Type | Example Codes | Classification | Retry Strategy |
|------------|--------------|----------------|----------------|
| Insufficient Funds | `51`, `insufficient_funds` | PAST_DUE | Daily retry × 20 |
| Card Declined | `05`, `card_declined` | PAST_DUE | Daily retry × 20 |
| Do Not Honor | `04`, `do_not_honor` | PAST_DUE | Daily retry × 20 |
| Expired Card | `54`, `expired_card` | ERROR | No retry (update required) |
| Invalid Card | `14`, `invalid_card_number` | ERROR | No retry (update required) |
| Fraud Suspected | `fraud_detected` | ERROR | No retry (verification required) |
| Gateway Error | `500`, `timeout` | ERROR | No retry (technical issue) |

### Retry Schedule

<Tabs>
  <Tab title="PAST_DUE (Retryable)">
    ```
    Day 1:  Attempt 1 → Failed
            Status: past_due
            Action: Send friendly reminder

    Day 2:  Attempt 2 → Failed
            Action: Silent retry

    Day 3:  Attempt 3 → Failed
            Action: Silent retry

    Day 4:  Attempt 4 → Failed
            Action: Send urgent reminder (4th attempt)

    Days 5-7: Silent retries

    Day 8:  Attempt 8 → Failed
            Action: Send urgent reminder (8th attempt)

    Days 9-11: Silent retries

    Day 12: Attempt 12 → Failed
            Action: Send urgent reminder (12th attempt)

    Days 13-15: Silent retries

    Day 16: Attempt 16 → Failed
            Action: Send urgent reminder (16th attempt)

    Days 17-19: Silent retries

    Day 20: Attempt 20 → Failed (FINAL)
            Status: error
            Action: Send final notice

    Day 21: No retry
            Status: expired
            Action: Cancel subscription
    ```
  </Tab>

  <Tab title="ERROR (Requires Action)">
    ```
    Day 1:  Attempt 1 → Failed (expired card)
            Status: error
            Action: Send immediate notification
                   "Please update payment method"

    Day 2+: No automatic retries
            Status: remains error
            Action: Customer must update card

    When customer updates:
            System: Automatically use new card
            Next scheduled: Normal billing resumes
    ```
  </Tab>
</Tabs>

<Info>
Customers can update payment methods at any time during the retry period. The next retry automatically uses the new card without manual intervention.
</Info>

### Retry Prevention

Journey implements safeguards to prevent excessive retry attempts:

**Daily Limit:** Only one retry attempt per payment per day
- Prevents rapid-fire retry attempts that could trigger fraud detection
- Reduces payment processor fees from multiple failed attempts
- Gives customers time to resolve underlying issues (add funds, update card, etc.)

**Time Window:** Retries only occur after 8 AM local time
- Avoids charging customers during overnight hours
- Aligns with business hours when customers can respond
- Reduces customer support inquiries about unexpected charges

**Already Attempted Check:** System tracks the last attempt timestamp
- Skips retry if already attempted today
- Prevents duplicate charges if cron job runs multiple times
- Ensures predictable billing behavior for customers

## Payment Method Management

### Adding Payment Methods

<Steps>
<Step title="Create Checkout Session">
```bash
POST /api/v1/straumur/create-session-add-card/
{
  "customer_id": 42,
  "return_url": "https://yourstore.com/payment-success"
}
```

**Response:**
```json
{
  "checkoutUrl": "https://checkout.straumur.is/...",
  "session_id": "sess_abc123"
}
```
</Step>

<Step title="Redirect Customer">
Redirect customer to `checkoutUrl` for card entry and verification.
</Step>

<Step title="Webhook Callback">
Journey receives webhook when verification completes:

```json
{
  "event": "payment_method.verified",
  "payment_method_id": "pm_xyz789",
  "card_last_four": "4242",
  "card_type": "visa",
  "expiry": "12/2027"
}
```
</Step>

<Step title="Set as Primary">
```python
payment_method = PaymentMethod.objects.get(id="pm_xyz789")
payment_method.status = "active"
payment_method.save()

customer.primary_payment_method = payment_method
customer.save()
```

**Result:** Next billing cycle uses new card
</Step>
</Steps>

### Updating During Dunning

**Scenario:** Payment fails, customer updates card while in retry period.

**Journey's Seamless Recovery:**
1. Customer adds new payment method through the customer portal
2. New card is automatically set as their primary payment method
3. The very next retry attempt (could be within hours) uses the new card
4. If the new card charges successfully, subscription immediately returns to active status
5. Customer experiences no service interruption or missed deliveries

**Behind the Scenes:**
- System always uses the customer's current primary payment method for retry attempts
- No manual intervention needed from support or merchant
- Subscription status updates automatically based on payment success
- Delivery schedules remain intact if payment recovered within retry window

<Tip>
This seamless recovery is a key feature - customers can fix payment issues without contacting support or missing deliveries. The system is designed to "just work" when customers update their payment information.
</Tip>

## Refunds and Adjustments

### Full Refund

**Process:**
- Merchant initiates refund for the entire payment amount
- System calls the payment processor's refund API
- If successful, payment status updates to `REFUNDED`
- Customer receives credit to their original payment method

### Partial Refund

**Process:**
- Merchant specifies a specific amount to refund (e.g., for a damaged item)
- System calls processor API with the partial amount
- Refund amount is tracked separately from original payment amount
- Customer receives partial credit while payment remains in their history

### Refund Timeline

<Steps>
<Step title="Refund Requested">
Merchant initiates refund via admin or API
</Step>

<Step title="Processor API Call">
Journey calls payment processor refund endpoint
</Step>

<Step title="Bank Processing">
**Timeframes:**
- Straumur: 3-5 business days
- Reepay: 5-7 business days
- Rapyd: Varies by country (3-10 days)
</Step>

<Step title="Customer Sees Credit">
Refund appears on customer's bank statement
</Step>
</Steps>

<Warning>
Refunds cannot be reversed once processed. Always confirm amount and reason before executing.
</Warning>

## Invoice Generation

Journey automatically generates invoices for every successful payment.

### Invoice Data Model

```json
{
  "payment_id": "pay_123",
  "invoice_number": "INV-2025-001234",
  "customer": {
    "name": "Jón Jónsson",
    "address": "Laugavegur 1, 101 Reykjavík"
  },
  "line_items": [
    {
      "description": "Fresh Milk × 2",
      "unit_price": 500,
      "quantity": 2,
      "total": 1000
    },
    {
      "description": "Delivery Fee",
      "unit_price": 500,
      "quantity": 1,
      "total": 500
    }
  ],
  "subtotal": 1500,
  "tax": 360,
  "total": 1860,
  "payment_method": "Visa •••• 4242",
  "payment_date": "2025-11-01T12:34:56Z"
}
```

### Auto-Send Invoices

Enable automatic invoice delivery per customer through their account settings. When enabled:

**Trigger:** After every successful payment settlement

**Email Contents:**
- PDF invoice attachment
- HTML summary in email body
- Payment confirmation details
- Next billing date information

**Configuration:**
- Enabled per-customer (not global)
- Can be toggled on/off at any time
- Immediate effect on next payment

## Stock Management Integration

Journey integrates payment status with stock management:

### Stock Lifecycle

<Steps>
<Step title="Order Created">
**Stock Availability Check:**
- System verifies all items are in stock before creating order
- If any item is unavailable, order creation fails
- Prevents overselling and customer disappointment
</Step>

<Step title="Payment Authorized">
**Stock Reservation:**
- When payment is pre-authorized, stock is reserved for this order
- Reserved stock is temporarily unavailable to other customers
- Ensures items will be available when payment captures
</Step>

<Step title="Payment Settled">
**Stock Fulfillment:**
- Once payment fully settles, stock is permanently reduced
- Reservation is removed (no longer needed)
- Order moves to fulfillment queue
</Step>

<Step title="Payment Failed">
**Stock Unreservation:**
- If payment fails or is cancelled, reserved stock is released
- Items become available again for other customers
- Prevents stock being locked indefinitely for failed orders
</Step>
</Steps>

<Info>
This integration ensures inventory accuracy and prevents overselling during payment processing delays.
</Info>

## Security & Compliance

### PCI DSS Compliance

Journey never stores raw card data:

**Secure Flow:**
```
Customer enters card
    ↓
Directly to processor (Straumur/Reepay/Rapyd)
    ↓
Processor returns token
    ↓
Journey stores token only
    ↓
Token used for charges
```

**Journey stores:**
- ✅ Payment method tokens
- ✅ Last 4 digits
- ✅ Card type (Visa, Mastercard)
- ✅ Expiry date

**Journey never stores:**
- ❌ Full card numbers
- ❌ CVV codes
- ❌ PIN numbers

### 3D Secure Support

All processors support 3D Secure authentication:

```json
{
  "requires_3ds": true,
  "redirect_url": "https://secure.bank.com/verify",
  "challenge_required": true
}
```

**Flow:**
1. Customer initiates payment
2. Bank requires 3DS challenge
3. Customer redirected to bank verification
4. After verification, return to Journey
5. Payment completes

### Data Protection

**Encryption:**
- All API calls use TLS 1.3
- Database fields encrypted at rest
- Payment tokens encrypted with AES-256

**Access Control:**
- Multi-tenant data isolation
- Role-based permissions
- Audit logging for all payment actions

## Best Practices

<AccordionGroup>
  <Accordion title="Always Verify Payment Methods" icon="shield-check">
    Before activating subscriptions, verify payment methods through processor checkout flows. This reduces first-payment failures by 80%.
  </Accordion>

  <Accordion title="Set Appropriate Retry Limits" icon="repeat">
    Default 20 attempts works for most businesses. Reduce to 10-15 for high-value subscriptions to limit exposure. Increase to 25-30 for low-value, high-retention products.
  </Accordion>

  <Accordion title="Monitor Payment Failure Rates" icon="chart-line">
    Healthy businesses see 5-10% payment failure rates. Above 15% indicates issues:
    - Expired cards not updated
    - Pricing too aggressive
    - Poor dunning communication
  </Accordion>

  <Accordion title="Offer Self-Service Updates" icon="user-gear">
    Enable customers to update payment methods without support contact. This recovers 40% of failed payments within 48 hours.
  </Accordion>

  <Accordion title="Communicate Before Charging" icon="bell">
    Send delivery reminders 1-2 days before charging. This gives customers time to update cards and reduces "unexpected charge" disputes by 60%.
  </Accordion>

  <Accordion title="Use Multi-Frequency Strategically" icon="calendar-days">
    Batch items with similar frequencies (weekly, bi-weekly, monthly) to optimize transaction fees while maintaining flexibility.
  </Accordion>

  <Accordion title="Implement Grace Periods" icon="clock">
    For delivered-but-unpaid scenarios, continue retry attempts beyond normal limits since customer received goods. This protects revenue while maintaining goodwill.
  </Accordion>

  <Accordion title="Track Processor Performance" icon="gauge">
    Monitor success rates by processor. Straumur: 92%+, Reepay: 88%+, Rapyd: 85%+ are healthy benchmarks. Switch processors if consistently below.
  </Accordion>
</AccordionGroup>

## Troubleshooting

### High Decline Rates

**Symptoms:**
- >15% of payments failing
- Many "insufficient funds" errors
- High churn rate

**Solutions:**
1. **Optimize billing dates** - Align with paydays (1st, 15th of month)
2. **Pre-charge notifications** - Remind customers 24-48 hours ahead
3. **Retry timing** - Try early morning (better success rates)
4. **Payment method diversity** - Accept multiple payment types

### Stuck Authorizations

**Symptoms:**
- Payments remain "authorized" for days
- Customers see pending charges
- Revenue not captured

**Solutions:**
1. **Check auto-capture settings**
2. **Manual capture** - `POST /api/v1/payment/{id}/capture`
3. **Monitor authorization expiry** - Capture within 7 days
4. **Enable auto-capture** - In processor settings

### Webhook Failures

**Symptoms:**
- Payment status not updating
- Missing refund confirmations
- Delayed subscription status changes

**Solutions:**
1. **Verify webhook URLs** - Check processor dashboard
2. **Test webhook endpoint** - `POST /webhooks/straumur/test`
3. **Check webhook secrets** - Ensure correct verification
4. **Review logs** - `/var/log/webhooks.log`

## API Reference

<CardGroup cols={3}>
  <Card title="Create Payment" icon="plus" href="/api/payments/create">
    Create new payment
  </Card>
  <Card title="Get Payment" icon="eye" href="/api/payments/get">
    Retrieve details
  </Card>
  <Card title="Charge Payment" icon="credit-card" href="/api/payments/charge">
    Execute charge
  </Card>
  <Card title="Capture Authorization" icon="lock-open" href="/api/payments/capture">
    Capture pre-auth
  </Card>
  <Card title="Refund Payment" icon="rotate-left" href="/api/payments/refund">
    Process refund
  </Card>
  <Card title="Payment History" icon="clock-rotate-left" href="/api/payments/history">
    View transaction log
  </Card>
  <Card title="Add Payment Method" icon="wallet" href="/api/payment-methods/add">
    Add customer card
  </Card>
  <Card title="Update Primary Method" icon="star" href="/api/payment-methods/set-primary">
    Change default card
  </Card>
  <Card title="Delete Payment Method" icon="trash" href="/api/payment-methods/delete">
    Remove card
  </Card>
</CardGroup>

## Related Concepts

<CardGroup cols={2}>
  <Card
    title="Subscriptions"
    icon="repeat"
    href="/concepts/subscriptions"
  >
    Understand subscription lifecycle and how payments integrate with recurring orders
  </Card>
  <Card
    title="Dunning Management"
    icon="triangle-exclamation"
    href="/concepts/dunning"
  >
    Deep dive into payment failure recovery and customer retention strategies
  </Card>
  <Card
    title="Communications"
    icon="envelope"
    href="/concepts/communication"
  >
    Learn how payment events trigger automated customer notifications
  </Card>
  <Card
    title="Reports & Analytics"
    icon="chart-bar"
    href="/concepts/reports"
  >
    Track payment performance, revenue metrics, and failure analysis
  </Card>
</CardGroup>
